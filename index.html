<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>请购单号自动生成系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#93c5fd',
                        neutral: '#f1f5f9',
                        dark: '#0f172a'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            .animate-slide {
                animation: slide 20s linear infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
            }
            @keyframes slide {
                0% { transform: translateY(0); }
                100% { transform: translateY(-100%); }
            }
        }
    </style>
</head>
<body class="font-inter bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- 登录页面 -->
    <div id="loginPage" class="fixed inset-0 flex items-center justify-center bg-white z-50">
        <div class="w-full max-w-md p-8 bg-white rounded-2xl shadow-xl transform transition-all duration-500 hover:shadow-2xl">
            <div class="text-center mb-8">
                <i class="fa fa-key text-4xl text-primary mb-4 animate-float"></i>
                <h2 class="text-2xl font-bold text-gray-800">请购单号生成系统</h2>
                <p class="text-gray-600 mt-2">请登录或注册账号</p>
            </div>
            
            <!-- 登录表单 -->
            <div id="loginForm">
                <div class="mb-4">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名 (真实姓名)</label>
                    <input type="text" id="loginUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请输入真实姓名">
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请输入密码">
                </div>
                <button id="loginBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    登录
                </button>
                <div class="mt-4 text-center">
                    <span class="text-gray-600">还没有账号?</span>
                    <button id="showRegisterBtn" class="text-primary hover:text-primary/80 font-medium ml-1 transition duration-300">立即注册</button>
                </div>
            </div>
            
            <!-- 注册表单 (默认隐藏) -->
            <div id="registerForm" class="hidden">
                <div class="mb-4">
                    <label for="registerUsername" class="block text-sm font-medium text-gray-700 mb-1">用户名 (真实姓名)</label>
                    <input type="text" id="registerUsername" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请输入真实姓名">
                </div>
                <div class="mb-4">
                    <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-1">密码</label>
                    <input type="password" id="registerPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请设置密码">
                </div>
                <div class="mb-6">
                    <label for="registerConfirmPassword" class="block text-sm font-medium text-gray-700 mb-1">确认密码</label>
                    <input type="password" id="registerConfirmPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请再次输入密码">
                </div>
                <button id="registerBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    注册
                </button>
                <div class="mt-4 text-center">
                    <span class="text-gray-600">已有账号?</span>
                    <button id="showLoginBtn" class="text-primary hover:text-primary/80 font-medium ml-1 transition duration-300">返回登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主页面 -->
    <div id="mainPage" class="hidden">
        <!-- 顶部导航栏 -->
        <header class="bg-primary text-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fa fa-file-text-o text-xl"></i>
                    <h1 class="text-xl font-bold">请购单号自动生成系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="welcomeMessage" class="text-sm font-medium"></div>
                    <button id="logoutBtn" class="flex items-center space-x-1 text-white hover:text-gray-200 transition duration-300">
                        <i class="fa fa-sign-out"></i>
                        <span>退出</span>
                    </button>
                    <button id="changePasswordBtn" class="flex items-center space-x-1 text-white hover:text-gray-200 transition duration-300">
                        <i class="fa fa-lock"></i>
                        <span>修改密码</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 主要内容区 -->
        <main class="container mx-auto px-4 py-6">
            <!-- 统计卡片 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 transform transition-all duration-500 hover:shadow-xl hover:-translate-y-1">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">今日请购单</p>
                            <h3 id="todayCount" class="text-3xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fa fa-file-text text-primary text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <i class="fa fa-arrow-up text-green-500 mr-1"></i>
                        <span class="text-green-500 font-medium">12%</span>
                        <span class="text-gray-500 ml-1">较昨日</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 transform transition-all duration-500 hover:shadow-xl hover:-translate-y-1">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">本月请购单</p>
                            <h3 id="monthCount" class="text-3xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="bg-indigo-100 p-3 rounded-lg">
                            <i class="fa fa-calendar-check-o text-indigo-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <i class="fa fa-arrow-up text-green-500 mr-1"></i>
                        <span class="text-green-500 font-medium">8%</span>
                        <span class="text-gray-500 ml-1">较上月</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 transform transition-all duration-500 hover:shadow-xl hover:-translate-y-1">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm">待处理申请</p>
                            <h3 id="pendingCount" class="text-3xl font-bold text-gray-800 mt-1">0</h3>
                        </div>
                        <div class="bg-amber-100 p-3 rounded-lg">
                            <i class="fa fa-clock-o text-amber-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center text-sm">
                        <i class="fa fa-arrow-down text-red-500 mr-1"></i>
                        <span class="text-red-500 font-medium">5%</span>
                        <span class="text-gray-500 ml-1">较昨日</span>
                    </div>
                </div>
            </div>
            
            <!-- 请购单明细表和输入窗体 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左侧：请购单号明细表 -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-800">请购单号明细表</h2>
                            <button id="exportBtn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition duration-300 flex items-center">
                                <i class="fa fa-download mr-1"></i> 导出Excel
                            </button>
                        </div>
                        
                        <div class="p-4">
                            <div class="relative h-[500px] overflow-hidden border border-gray-200 rounded-lg">
                                <div id="scrollContainer" class="absolute inset-0 overflow-y-auto pr-2 scrollbar-hide">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50 sticky top-0 z-10">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">请购单号</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">公司</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">部门</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类别</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申请人</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="purchaseTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- 表格内容将通过JavaScript动态生成 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：输入窗体 -->
                <div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">请购单信息</h2>
                        
                        <form id="purchaseForm" class="space-y-4">
                            <div>
                                <label for="company" class="block text-sm font-medium text-gray-700 mb-1">公司名称</label>
                                <select id="company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300">
                                    <option value="FMI">晨曦金属(公司代号FMI)</option>
                                    <option value="TMI">海湾金属(公司代号TMI)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">部门</label>
                                <select id="department" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" disabled>
                                    <option value="SCZBB">生产装备部（部门代号SCZBB）</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700 mb-1">采购单类别</label>
                                <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300">
                                    <option value="">建设(类别代号空)</option>
                                    <option value="SC">生产（类别代号SC）</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                                <input type="month" id="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300">
                            </div>
                            
                            <div>
                                <label for="applicant" class="block text-sm font-medium text-gray-700 mb-1">申请人</label>
                                <input type="text" id="applicant" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" readonly>
                            </div>
                            
                            <div class="pt-2">
                                <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary flex items-center justify-center">
                                    <i class="fa fa-plus-circle mr-2"></i> 生成请购单号
                                </button>
                            </div>
                        </form>
                        
                        <!-- 生成的请购单号预览 -->
                        <div id="generatedNumberContainer" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">生成的请购单号</h3>
                            <div id="generatedNumber" class="text-lg font-bold text-primary bg-blue-50 p-3 rounded-lg text-center"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- 页脚 -->
        <footer class="bg-dark text-white py-6 mt-10">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-lg font-semibold">请购单号自动生成系统</h3>
                        <p class="text-gray-400 text-sm mt-1">© 2025 版权所有</p>
                    </div>
                    <div class="flex space-x-6">
                        <a href="#" class="text-gray-400 hover:text-white transition duration-300">
                            <i class="fa fa-question-circle"></i> 帮助中心
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition duration-300">
                            <i class="fa fa-envelope"></i> 联系我们
                        </a>
                        <a href="#" class="text-gray-400 hover:text-white transition duration-300">
                            <i class="fa fa-shield"></i> 隐私政策
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- 修改密码的模态框 -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300 scale-95 opacity-0" id="changePasswordModalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">修改密码</h3>
                <button id="closeChangePasswordModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="changePasswordForm" class="space-y-4">
                <div>
                    <label for="oldPassword" class="block text-sm font-medium text-gray-700 mb-1">当前密码</label>
                    <input type="password" id="oldPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请输入当前密码">
                </div>
                
                <div>
                    <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">新密码</label>
                    <input type="password" id="newPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请输入新密码">
                </div>
                
                <div>
                    <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">确认新密码</label>
                    <input type="password" id="confirmNewPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" placeholder="请再次输入新密码">
                </div>
                
                <div class="pt-2">
                    <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary flex items-center justify-center">
                        <i class="fa fa-save mr-2"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 修改请购单的模态框 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">修改请购单</h3>
                <button id="closeEditModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">请购单号</label>
                    <input type="text" id="editNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" disabled>
                </div>
                
                <div>
                    <label for="editCompany" class="block text-sm font-medium text-gray-700 mb-1">公司名称</label>
                    <select id="editCompany" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300">
                        <option value="FMI">晨曦金属(公司代号FMI)</option>
                        <option value="TMI">海湾金属(公司代号TMI)</option>
                    </select>
                </div>
                
                <div>
                    <label for="editCategory" class="block text-sm font-medium text-gray-700 mb-1">采购单类别</label>
                    <select id="editCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300">
                        <option value="">建设(类别代号空)</option>
                        <option value="SC">生产（类别代号SC）</option>
                    </select>
                </div>
                
                <div>
                    <label for="editDate" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                    <input type="month" id="editDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300">
                </div>
                
                <div>
                    <label for="editApplicant" class="block text-sm font-medium text-gray-700 mb-1">申请人</label>
                    <input type="text" id="editApplicant" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition duration-300" readonly>
                </div>
                
                <div class="pt-2">
                    <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition duration-300 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary flex items-center justify-center">
                        <i class="fa fa-save mr-2"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 查看操作记录的模态框 -->
    <div id="historyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all duration-300 scale-95 opacity-0" id="historyModalContent">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">操作记录</h3>
                <button id="closeHistoryModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="relative h-[300px] overflow-hidden border border-gray-200 rounded-lg">
                <div id="historyContainer" class="absolute inset-0 overflow-y-auto pr-2 scrollbar-hide">
                    <ul id="historyList" class="divide-y divide-gray-200">
                        <!-- 历史记录将通过JavaScript动态生成 -->
                    </ul>
                </div>
            </div>
            
            <div class="mt-4">
                <button id="closeHistoryBtn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2.5 px-4 rounded-lg transition duration-300">
                    关闭
                </button>
            </div>
        </div>
    </div>

    <script>
        // 数据存储
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let purchaseOrders = JSON.parse(localStorage.getItem('purchaseOrders')) || [];
        let currentUser = null;
        
        // 检查是否存在管理员账号，如果不存在则创建
        if (!users['李奥新']) {
            users['李奥新'] = {
                password: '369852',
                createdAt: new Date().toISOString(),
                isAdmin: true
            };
            localStorage.setItem('users', JSON.stringify(users));
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为当前月份
            const today = new Date();
            const month = today.getMonth() + 1;
            const year = today.getFullYear();
            document.getElementById('date').value = `${year}-${month.toString().padStart(2, '0')}`;
            
            // 检查是否有已登录用户
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showMainPage();
            }
            
            // 注册事件监听器
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('registerBtn').addEventListener('click', register);
            document.getElementById('showRegisterBtn').addEventListener('click', showRegisterForm);
            document.getElementById('showLoginBtn').addEventListener('click', showLoginForm);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('purchaseForm').addEventListener('submit', generatePurchaseOrder);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('editForm').addEventListener('submit', savePurchaseOrder);
            document.getElementById('closeHistoryModal').addEventListener('click', closeHistoryModal);
            document.getElementById('closeHistoryBtn').addEventListener('click', closeHistoryModal);
            document.getElementById('changePasswordBtn').addEventListener('click', openChangePasswordModal);
            document.getElementById('closeChangePasswordModal').addEventListener('click', closeChangePasswordModal);
            document.getElementById('changePasswordForm').addEventListener('submit', changePassword);
            
            // 更新统计数据
            updateStatistics();
            
            // 显示请购单表格
            renderPurchaseTable();
        });
        
        // 登录功能
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showToast('请输入用户名和密码', 'error');
                return;
            }
            
            if (users[username] && users[username].password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', username);
                showMainPage();
                showToast('登录成功', 'success');
            } else {
                showToast('用户名或密码错误', 'error');
            }
        }
        
        // 注册功能
        function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!username || !password) {
                showToast('用户名和密码不能为空', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('两次输入的密码不一致', 'error');
                return;
            }
            
            if (users[username]) {
                showToast('该用户已存在', 'error');
                return;
            }
            
            // 注册新用户
            users[username] = {
                password: password,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('users', JSON.stringify(users));
            showToast('注册成功，请登录', 'success');
            showLoginForm();
        }
        
        // 显示注册表单
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }
        
        // 显示登录表单
        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }
        
        // 显示主页面
        function showMainPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('welcomeMessage').textContent = `欢迎回来，${currentUser}${users[currentUser].isAdmin ? ' (管理员)' : ''}`;
            
            // 设置申请人为当前登录用户
            document.getElementById('applicant').value = currentUser;
            
            // 刷新表格数据
            renderPurchaseTable();
            updateStatistics();
        }
        
        // 登出功能
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('mainPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showToast('已成功登出', 'info');
        }
        
        // 打开修改密码模态框
        function openChangePasswordModal() {
            // 显示模态框
            document.getElementById('changePasswordModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('changePasswordModalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('changePasswordModalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭修改密码模态框
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModalContent').classList.remove('scale-100', 'opacity-100');
            document.getElementById('changePasswordModalContent').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('changePasswordModal').classList.add('hidden');
            }, 300);
        }
        
        // 修改密码
        function changePassword(e) {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showToast('请填写所有字段', 'error');
                return;
            }
            
            if (users[currentUser].password !== oldPassword) {
                showToast('当前密码不正确', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showToast('两次输入的新密码不一致', 'error');
                return;
            }
            
            // 更新密码
            users[currentUser].password = newPassword;
            localStorage.setItem('users', JSON.stringify(users));
            
            // 关闭模态框
            closeChangePasswordModal();
            
            // 显示成功提示
            showToast('密码修改成功', 'success');
            
            // 重置表单
            document.getElementById('changePasswordForm').reset();
        }
        
        // 生成请购单号 - 修正格式
        function generateOrderNumber(company, department, category, year, month, day) {
            // 获取当月已有的请购单数量，不考虑申请人
            const currentMonth = `${year}-${month.toString().padStart(2, '0')}`;
            const currentMonthOrders = purchaseOrders.filter(order => 
                order.date.startsWith(currentMonth) && 
                order.company === company && 
                order.department === department && 
                (order.category === category || (order.category === '' && category === '') || (order.category === 'SC' && category === 'SC'))
            );
            
            // 生成顺序号，从01开始（两位数）
            const sequenceNumber = (currentMonthOrders.length + 1).toString().padStart(2, '0');
            
            // 构建请购单号
            if (category === 'SC') {
                // 生产类：公司代码+部门代码-SC-年份-月份日期顺序号
                return `${company}${department}-${category}-${year}-${month}${day}${sequenceNumber}`;
            } else {
                // 建设类：公司代码+部门代码+年份-月份日期顺序号
                return `${company}${department}${year}-${month}${day}${sequenceNumber}`;
            }
        }
        
        // 生成请购单号
        function generatePurchaseOrder(e) {
            e.preventDefault();
            
            const company = document.getElementById('company').value;
            const department = document.getElementById('department').value;
            const category = document.getElementById('category').value;
            const date = document.getElementById('date').value;
            // 申请人自动设为当前登录用户
            const applicant = currentUser;
            
            if (!date) {
                showToast('请选择日期', 'error');
                return;
            }
            
            // 解析日期
            const [year, month] = date.split('-');
            const dateObj = new Date(year, month - 1);
            const formattedDate = `${year}年${month}月`;
            const day = new Date().getDate().toString().padStart(2, '0'); // 获取当前日期
            
            // 生成请购单号
            const orderNumber = generateOrderNumber(company, department, category, year, month, day);
            
            // 创建新的请购单对象
            const newOrder = {
                id: Date.now().toString(), // 使用时间戳作为唯一ID
                orderNumber: orderNumber,
                company: company,
                department: department,
                category: category,
                date: date,
                formattedDate: formattedDate,
                applicant: applicant,
                createdAt: new Date().toISOString(),
                history: [
                    {
                        action: '创建',
                        user: applicant,
                        timestamp: new Date().toISOString()
                    }
                ]
            };
            
            // 添加到列表
            purchaseOrders.unshift(newOrder); // 改为添加到数组开头，使最新记录显示在顶部
            
            // 保存到本地存储
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            
            // 显示生成的请购单号
            document.getElementById('generatedNumber').textContent = orderNumber;
            document.getElementById('generatedNumberContainer').classList.remove('hidden');
            
            // 刷新表格
            renderPurchaseTable();
            updateStatistics();
            
            // 重置表单
            document.getElementById('purchaseForm').reset();
            document.getElementById('date').value = `${year}-${month.toString().padStart(2, '0')}`;
            document.getElementById('applicant').value = currentUser;
            
            // 显示成功提示
            showToast('请购单号生成成功', 'success');
            
            // 添加新记录的高亮动画
            highlightNewRecord(newOrder.id);
        }
        
        // 高亮显示新生成的记录
        function highlightNewRecord(id) {
            const tableBody = document.getElementById('purchaseTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            if (rows.length > 0) {
                const firstRow = rows[0];
                firstRow.classList.add('bg-blue-50');
                
                setTimeout(() => {
                    firstRow.classList.remove('bg-blue-50');
                }, 2000);
            }
        }
        
        // 渲染请购单表格
        function renderPurchaseTable() {
            const tableBody = document.getElementById('purchaseTableBody');
            tableBody.innerHTML = '';
            
            if (purchaseOrders.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fa fa-file-text-o text-4xl mb-3 text-gray-300"></i>
                            <p>暂无请购单记录</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            // 按创建时间降序排序
            const sortedOrders = [...purchaseOrders].sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            );
            
            sortedOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-200';
                
                // 获取公司名称
                const companyName = order.company === 'FMI' ? '晨曦金属' : '海湾金属';
                
                // 获取类别名称
                const categoryName = order.category === 'SC' ? '生产' : '建设';
                
                // 格式化创建时间
                const createdDate = new Date(order.createdAt);
                const formattedCreatedDate = createdDate.toLocaleString();
                
                // 构建操作按钮
                let actions = '';
                if (order.applicant === currentUser || (users[currentUser] && users[currentUser].isAdmin)) {
                    actions = `
                        <div class="flex space-x-2">
                            <button class="text-blue-500 hover:text-blue-700" onclick="openEditModal('${order.id}')">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="deletePurchaseOrder('${order.id}')">
                                <i class="fa fa-trash"></i>
                            </button>
                            <button class="text-gray-500 hover:text-gray-700" onclick="viewHistory('${order.id}')">
                                <i class="fa fa-history"></i>
                            </button>
                        </div>
                    `;
                } else {
                    actions = `
                        <div class="flex space-x-2">
                            <button class="text-gray-500 hover:text-gray-700" onclick="viewHistory('${order.id}')">
                                <i class="fa fa-history"></i>
                            </button>
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.orderNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${companyName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">生产装备部</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${categoryName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.applicant}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${actions}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // 打开编辑模态框
        function openEditModal(id) {
            const order = purchaseOrders.find(order => order.id === id);
            if (!order) return;
            
            document.getElementById('editId').value = order.id;
            document.getElementById('editNumber').value = order.orderNumber;
            document.getElementById('editCompany').value = order.company;
            document.getElementById('editCategory').value = order.category;
            document.getElementById('editDate').value = order.date;
            document.getElementById('editApplicant').value = order.applicant;
            
            // 显示模态框
            document.getElementById('editModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('modalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭编辑模态框
        function closeEditModal() {
            document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modalContent').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('editModal').classList.add('hidden');
            }, 300);
        }
        
        // 保存修改的请购单
        function savePurchaseOrder(e) {
            e.preventDefault();
            
            const id = document.getElementById('editId').value;
            const company = document.getElementById('editCompany').value;
            const category = document.getElementById('editCategory').value;
            const date = document.getElementById('editDate').value;
            
            const orderIndex = purchaseOrders.findIndex(order => order.id === id);
            if (orderIndex === -1) return;
            
            // 获取当前日期
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const [year, month] = date.split('-');
            
            // 更新请购单信息
            const updatedOrder = {
                ...purchaseOrders[orderIndex],
                company: company,
                category: category,
                date: date,
                formattedDate: `${date.split('-')[0]}年${date.split('-')[1]}月`,
                history: [
                    ...purchaseOrders[orderIndex].history,
                    {
                        action: '修改',
                        user: currentUser,
                        timestamp: new Date().toISOString()
                    }
                ]
            };
            
            // 更新请购单号
            updatedOrder.orderNumber = generateOrderNumber(company, updatedOrder.department, category, year, month, day);
            
            // 更新列表
            purchaseOrders[orderIndex] = updatedOrder;
            
            // 保存到本地存储
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            
            // 关闭模态框
            closeEditModal();
            
            // 刷新表格
            renderPurchaseTable();
            
            // 显示成功提示
            showToast('请购单修改成功', 'success');
            
            // 高亮显示修改的记录
            highlightUpdatedRecord(id);
        }
        
        // 高亮显示修改的记录
        function highlightUpdatedRecord(id) {
            const tableBody = document.getElementById('purchaseTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const orderNumber = row.querySelector('td:first-child').textContent;
                const order = purchaseOrders.find(o => o.orderNumber === orderNumber);
                
                if (order && order.id === id) {
                    row.classList.add('bg-green-50');
                    
                    setTimeout(() => {
                        row.classList.remove('bg-green-50');
                    }, 2000);
                }
            });
        }
        
        // 删除请购单
        function deletePurchaseOrder(id) {
            if (!confirm('确定要删除这个请购单吗？')) return;
            
            const orderIndex = purchaseOrders.findIndex(order => order.id === id);
            if (orderIndex === -1) return;
            
            // 添加删除记录
            const deletedOrder = {
                ...purchaseOrders[orderIndex],
                history: [
                    ...purchaseOrders[orderIndex].history,
                    {
                        action: '删除',
                        user: currentUser,
                        timestamp: new Date().toISOString()
                    }
                ]
            };
            
            // 从列表中移除
            purchaseOrders.splice(orderIndex, 1);
            
            // 保存到本地存储
            localStorage.setItem('purchaseOrders', JSON.stringify(purchaseOrders));
            
            // 刷新表格
            renderPurchaseTable();
            updateStatistics();
            
            // 显示成功提示
            showToast('请购单已删除', 'success');
        }
        
        // 查看操作记录
        function viewHistory(id) {
            const order = purchaseOrders.find(order => order.id === id);
            if (!order) return;
            
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (order.history.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'px-4 py-3 text-center text-gray-500';
                emptyItem.textContent = '没有操作记录';
                historyList.appendChild(emptyItem);
                return;
            }
            
            // 按时间降序排序
            const sortedHistory = [...order.history].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            sortedHistory.forEach(record => {
                const item = document.createElement('li');
                item.className = 'px-4 py-3 border-b border-gray-200 last:border-0';
                
                const timestamp = new Date(record.timestamp);
                const formattedTimestamp = timestamp.toLocaleString();
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-gray-900">${record.user} ${record.action}</p>
                            <p class="text-xs text-gray-500 mt-1">${formattedTimestamp}</p>
                        </div>
                        ${record.action === '删除' ? '<span class="text-xs text-red-500 bg-red-50 px-2 py-0.5 rounded">已删除</span>' : ''}
                    </div>
                `;
                
                historyList.appendChild(item);
            });
            
            // 显示模态框
            document.getElementById('historyModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('historyModalContent').classList.remove('scale-95', 'opacity-0');
                document.getElementById('historyModalContent').classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        // 关闭历史记录模态框
        function closeHistoryModal() {
            document.getElementById('historyModalContent').classList.remove('scale-100', 'opacity-100');
            document.getElementById('historyModalContent').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('historyModal').classList.add('hidden');
            }, 300);
        }
        
        // 导出到Excel
        function exportToExcel() {
            if (purchaseOrders.length === 0) {
                showToast('没有请购单记录可导出', 'info');
                return;
            }
            
            // 准备导出数据
            const exportData = purchaseOrders.map(order => {
                // 获取公司名称
                const companyName = order.company === 'FMI' ? '晨曦金属' : '海湾金属';
                
                // 获取类别名称
                const categoryName = order.category === 'SC' ? '生产' : '建设';
                
                return {
                    '请购单号': order.orderNumber,
                    '公司': companyName,
                    '部门': '生产装备部',
                    '类别': categoryName,
                    '日期': order.formattedDate,
                    '申请人': order.applicant,
                    '创建时间': new Date(order.createdAt).toLocaleString()
                };
            });
            
            // 创建工作簿
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "请购单列表");
            
            // 生成文件名
            const today = new Date();
            const fileName = `请购单列表_${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}.xlsx`;
            
            // 导出文件
            XLSX.writeFile(wb, fileName);
            
            // 显示成功提示
            showToast('文件导出成功', 'success');
        }
        
        // 更新统计数据
        function updateStatistics() {
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
            const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toISOString();
            
            const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1).toISOString();
            const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59).toISOString();
            
            // 今日请购单数量
            const todayCount = purchaseOrders.filter(order => 
                order.createdAt >= todayStart && order.createdAt < todayEnd
            ).length;
            
            // 本月请购单数量
            const monthCount = purchaseOrders.filter(order => 
                order.createdAt >= thisMonthStart && order.createdAt < thisMonthEnd
            ).length;
            
            // 待处理申请数量（假设最近创建的5条为待处理）
            const pendingCount = Math.min(5, purchaseOrders.length);
            
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('monthCount').textContent = monthCount;
            document.getElementById('pendingCount').textContent = pendingCount;
        }
        
        // 显示提示消息
        function showToast(message, type = 'info') {
            // 创建提示元素
            const toast = document.createElement('div');
            
            // 设置样式和类
            let bgColor, icon;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-500';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-500';
                    icon = 'fa-exclamation-triangle';
                    break;
                default:
                    bgColor = 'bg-blue-500';
                    icon = 'fa-info-circle';
            }
            
            toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-500 translate-x-full flex items-center`;
            toast.innerHTML = `<i class="fa ${icon} mr-2"></i> ${message}`;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 3000);
        }
    </script>
</body>
</html>